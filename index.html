<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>재배 보드</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  // Firebase App (the core Firebase SDK) is always required and must be listed first
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.24.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.24.0/firebase-analytics.js";
  import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.24.0/firebase-firestore.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAnfstiWWezjQY4YJ3YJae8tsTGb3s9F-k",
    authDomain: "spinachslave.firebaseapp.com",
    projectId: "spinachslave",
    storageBucket: "spinachslave.firebasestorage.app",
    messagingSenderId: "974550491647",
    appId: "1:974550491647:web:f6359153646a7ffc9307ca",
    measurementId: "G-5VNY8MXJ4S"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // ===== 데이터 =====
  let columns = JSON.parse(localStorage.getItem("farmData")) || [];
  let tasks = JSON.parse(localStorage.getItem("taskData")) || [];
  let historyStack = [];

  // ===== 히스토리 =====
  function saveHistory(){
    historyStack.push(JSON.stringify(columns));
    if(historyStack.length>50) historyStack.shift();
  }

  function undoAction(){
    if(historyStack.length===0){
      alert("되돌릴 작업이 없습니다.");
      return;
    }
    columns = JSON.parse(historyStack.pop());
    createUI();
  }

  document.addEventListener("keydown",(e)=>{
    if(e.ctrlKey && e.key==="z"){
      e.preventDefault();
      undoAction();
    }
  });

  // ===== 공용 =====
  async function saveData(){
    localStorage.setItem("farmData",JSON.stringify(columns));
    localStorage.setItem("taskData",JSON.stringify(tasks));

    try {
      await setDoc(doc(db, "farmBoards", "default"), {
        columns: columns,
        tasks: tasks,
        updated: new Date().toISOString()
      });
      alert("저장 완료 (localStorage + Firestore)");
    } catch(e) {
      console.error(e);
      alert("Firestore 저장 실패, console 확인");
    }
  }

  // ===== 나머지 기존 함수들 유지 =====
  // formatDate, updateClock, validateDate, formatDays, createModal 등
  // openDateEditor, saveDate, openMemoEditor, saveMemo 등
  // openChangeEditor, completeChangeNow, saveChange, createUI
  // addColumn, deleteColumn, addCard, deleteCard, markChangeNow
  // createTaskUI, addTask, deleteTask, markTaskNow
  // openTaskDateEditor, saveTaskDate, openTaskMemoEditor, saveTaskMemo
  // 기타 이벤트 리스너 및 초기화
</script>

<style>
/* 기존 스타일 그대로 유지 */
body{font-family:Arial;background:#f4f6f8;margin:0;padding:20px;}
#clock{font-size:18px;margin-bottom:20px;}
/* ... 이하 생략, 기존 스타일 그대로 복사 ... */
</style>
</head>

<body>

<h1 id="clock"></h1>

<div class="top-controls">
  <button onclick="addColumn()">열 추가</button>
  <button onclick="saveData()">저장</button>
  <button onclick="undoAction()">이전 행동 복구</button>
</div>
<hr style="margin:40px 0;border:1px dashed #bbb">

<h2 id="farmTitle"
    contenteditable="true"
    oninput="localStorage.setItem('farmBoardTitle', this.innerText)">
  재배기 현황
</h2>
<div class="board" id="board"></div>
<hr style="margin:40px 0;border:1px dashed #bbb">

<h2 id="taskTitle"
    contenteditable="true"
    oninput="localStorage.setItem('taskBoardTitle', this.innerText)">
  작업 배너
</h2>

<div id="taskBoard" style="display:flex;flex-direction:column;gap:12px;"></div>

<script type="module">
// 여기서 기존 createUI(), createTaskUI(), 기타 CRUD 함수들 그대로 정의
// + setInterval(updateClock,1000);
// + 초기 createUI(), createTaskUI(), updateClock();
</script>

</body>
</html>
