<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>재배 보드</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:20px;}
#clock{font-size:18px;margin:0;}
.top-controls{display:flex;gap:10px;}
.top-controls button{padding:8px 14px;border:none;border-radius:8px;background:#6c8fc7;color:white;cursor:pointer;}
.board{display:flex;gap:20px;align-items:flex-start;}
.column{background:#e9eef5;padding:12px;border-radius:20px;width:300px;display:flex;flex-direction:column;}
.column-header{background:#6c8fc7;color:white;padding:10px;border-radius:16px;font-weight:bold;display:flex;justify-content:space-between;}
.card-container{margin-top:10px;display:flex;flex-direction:column;gap:12px;}
.card{background:white;padding:16px;border-radius:18px;box-shadow:0 2px 6px rgba(0,0,0,0.1);position:relative;}
.label{font-weight:bold;margin-bottom:10px;outline:none;}
.date-section{display:flex;justify-content:space-between;margin-top:6px;}
.date-block{width:48%;display:flex;flex-direction:column;}
.small{font-size:11px;color:#666;}
.big{font-size:18px;font-weight:bold;margin:2px 0;}
.date-text{font-size:13px;}
.divider-vertical{width:1px;background:rgba(0,0,0,0.15);}
.memo-divider{height:1px;background:rgba(0,0,0,0.2);margin:10px 0 6px 0;}
.memo{font-size:13px;}
.error{color:red;font-weight:bold;font-size:12px;margin-top:4px;}
.change-info{font-size:12px;margin-top:8px;color:#444;display:flex;align-items:center;gap:6px;}
.change-info.orange{color:orange;font-weight:bold;}
.change-info.red{color:red;font-weight:bold;text-decoration:underline;}
.card-menu{position:absolute;top:8px;right:10px;cursor:pointer;}
.card-options{display:none;position:absolute;top:26px;right:8px;background:white;border:1px solid #ccc;border-radius:8px;padding:6px;font-size:12px;z-index:1000;}
.card-options div{padding:6px 8px;cursor:pointer;}
.card-options div:hover{background:#f0f0f0;}
.add-card-btn{margin-top:10px;padding:10px 0;border:none;border-radius:16px;background:#d0d8e8;font-size:22px;cursor:pointer;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;z-index:2000;}
.modal-content{background:white;padding:30px;border-radius:20px;width:600px;display:flex;flex-direction:column;gap:20px;}
.modal-fields{display:flex;gap:30px;justify-content:center;}
.modal-block{display:flex;flex-direction:column;gap:6px;align-items:center;}
.modal-block input{width:90px;padding:8px;border-radius:10px;border:1px solid #ccc;text-align:center;}
.modal-buttons{display:flex;justify-content:flex-end;gap:10px;}
.save-btn{background:#6c8fc7;color:white;padding:8px 16px;border:none;border-radius:10px;}
.cancel-btn{background:#ccc;padding:8px 16px;border:none;border-radius:10px;}
.mark-btn{background:#28a745;color:white;padding:4px 8px;border:none;border-radius:10px;font-size:11px;}
.task-card{
  background:white;
  padding:14px 20px;
  border-radius:18px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  display:flex;
  align-items:center;
  gap:20px;
  position:relative;
}
.top-bar{
  display:flex;
  align-items:center;
  margin-bottom:20px;
}
.top-controls{
  margin-left:auto;
  display:flex;
  gap:10px;
}
</style>
</head>
<body>

<div class="top-bar">
  <h1 id="clock"></h1>
  <div class="top-controls">
    <button onclick="addColumn()">열 추가</button>
    <button onclick="saveData()">저장(Firestore)</button>
    <button onclick="undoAction()">이전 행동 복구</button>
  </div>
</div>
<hr style="margin:-5px 0;border:1px dashed #bbb">

<h2 id="farmTitle" contenteditable="true" oninput="localStorage.setItem('farmBoardTitle', this.innerText)">
  재배기 현황
</h2>
<div class="board" id="board"></div>
<hr style="margin:0px 0;border:1px dashed #bbb">

<h2 id="taskTitle" contenteditable="true" oninput="localStorage.setItem('taskBoardTitle', this.innerText)">
  작업 배너
</h2>
<div id="taskBoard" style="display:flex;flex-direction:column;gap:12px;"></div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-analytics.js";

// Firebase 설정
const firebaseConfig = {
  apiKey: "AIzaSyAnfstiWWezjQY4YJ3YJae8tsTGb3s9F-k",
  authDomain: "spinachslave.firebaseapp.com",
  projectId: "spinachslave",
  storageBucket: "spinachslave.firebasestorage.app",
  messagingSenderId: "974550491647",
  appId: "1:974550491647:web:f6359153646a7ffc9307ca",
  measurementId: "G-5VNY8MXJ4S"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);

// ===== 데이터 =====
let columns = [];
let tasks = [];
let historyStack = [];

// ===== Firestore 불러오기 =====
async function loadData(){
  // columns
  const colSnap = await getDocs(collection(db,"columns"));
  columns = [];
  colSnap.forEach(doc => {columns.push(doc.data());});

  // tasks
  const taskSnap = await getDocs(collection(db,"tasks"));
  tasks = [];
  taskSnap.forEach(doc => {tasks.push(doc.data());});

  createUI();
  createTaskUI();
}

// ===== Firestore 저장 =====
async function saveData(){
  // columns
  for(let i=0;i<columns.length;i++){
    await setDoc(doc(db,"columns","col"+i), columns[i]);
  }
  // tasks
  for(let i=0;i<tasks.length;i++){
    await setDoc(doc(db,"tasks","task"+i), tasks[i]);
  }
  alert("Firestore 저장 완료");
}

// ===== 히스토리 =====
function saveHistory(){historyStack.push(JSON.stringify(columns));if(historyStack.length>50) historyStack.shift();}
function undoAction(){if(historyStack.length===0){alert("되돌릴 작업이 없습니다.");return;}columns=JSON.parse(historyStack.pop());createUI();}

// ===== 날짜/시간 =====
function formatDate(d){if(!d) return "-";return `${d.year}.${String(d.month).padStart(2,"0")}.${String(d.day).padStart(2,"0")}`;}
function updateClock(){document.getElementById("clock").innerText=new Date().toLocaleString();}
function formatDays(date){if(!date) return "-";const diff=((new Date()-new Date(date.year,date.month-1,date.day,date.hour||0))/(1000*60*60*24)).toFixed(1);return diff+"일차";}

// ===== UI 생성 =====
function createUI(){
  const board=document.getElementById("board");
  board.innerHTML="";
  columns.forEach((col,ci)=>{
    const column=document.createElement("div");
    column.className="column";
    column.dataset.index=ci;
    column.innerHTML=`<div class="column-header">
      <div contenteditable oninput="columns[${ci}].header=this.innerText">${col.header}</div>
      <div onclick="deleteColumn(${ci})">✕</div>
    </div><div class="card-container"></div>`;
    board.appendChild(column);
    const container=column.querySelector(".card-container");
    col.crops.forEach((crop,ri)=>{
      const card=document.createElement("div"); card.className="card";
      card.innerHTML=`<div class="label" contenteditable oninput="columns[${ci}].crops[${ri}].name=this.innerText">${crop.name}</div>
      <div class="date-section">
        <div class="date-block"><div class="small">파종일</div><div class="big">${formatDays(crop.sow)}</div><div class="date-text">${formatDate(crop.sow)}</div></div>
        <div class="divider-vertical"></div>
        <div class="date-block"><div class="small">정식일</div><div class="big">${formatDays(crop.trans)}</div><div class="date-text">${formatDate(crop.trans)}</div></div>
      </div>`;
      container.appendChild(card);
    });
    new Sortable(container,{group:"shared",animation:150,onStart:()=>saveHistory(),onEnd:(evt)=>{
      const fromColIndex = evt.from.closest(".column").dataset.index;
      const toColIndex   = evt.to.closest(".column").dataset.index;
      const movedItem = columns[fromColIndex].crops.splice(evt.oldIndex,1)[0];
      columns[toColIndex].crops.splice(evt.newIndex,0,movedItem);
      createUI();
    }});
    const btn=document.createElement("button"); btn.className="add-card-btn"; btn.innerText="+"; btn.onclick=()=>addCard(ci); column.appendChild(btn);
  });
}

function createTaskUI(){
  const board=document.getElementById("taskBoard"); board.innerHTML="";
  tasks.forEach((task,i)=>{
    const card=document.createElement("div"); card.className="task-card";
    card.innerHTML=`<div contenteditable oninput="tasks[${i}].name=this.innerText">${task.name}</div>`;
    board.appendChild(card);
  });
}

// ===== CRUD =====
function addColumn(){saveHistory(); columns.push({header:"새 열",crops:[]}); createUI();}
function deleteColumn(i){if(confirm("정말 삭제하시겠습니까?")){saveHistory(); columns.splice(i,1); createUI();}}
function addCard(i){saveHistory(); const now=new Date(); columns[i].crops.push({name:"새 카드",sow:{year:now.getFullYear(),month:now.getMonth()+1,day:now.getDate()},trans:{year:now.getFullYear(),month:now.getMonth()+1,day:now.getDate()}}); createUI();}

// ===== 초기화 =====
setInterval(updateClock,1000);
loadData();

</script>
</body>
</html>
