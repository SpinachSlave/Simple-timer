<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>재배 보드</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:20px;}
#clock{font-size:18px;margin-bottom:20px;}
.top-controls{display:flex;gap:10px;margin-bottom:20px;}
.top-controls button{padding:8px 14px;border:none;border-radius:8px;background:#2d6cdf;color:white;cursor:pointer;}
.board{display:flex;gap:20px;align-items:flex-start;}
.column{background:#e9eef5;padding:12px;border-radius:20px;width:300px;display:flex;flex-direction:column;}
.column-header{background:#2d6cdf;color:white;padding:10px;border-radius:16px;font-weight:bold;display:flex;justify-content:space-between;}
.card-container{margin-top:10px;display:flex;flex-direction:column;gap:12px;}
.card{background:white;padding:16px;border-radius:18px;box-shadow:0 2px 6px rgba(0,0,0,0.1);position:relative;}
.label{font-weight:bold;margin-bottom:10px;outline:none;}
.date-section{display:flex;justify-content:space-between;margin-top:6px;}
.date-block{width:48%;display:flex;flex-direction:column;}
.small{font-size:11px;color:#666;}
.big{font-size:18px;font-weight:bold;margin:2px 0;}
.date-text{font-size:13px;}
.divider-vertical{width:1px;background:rgba(0,0,0,0.15);}
.memo-divider{height:1px;background:rgba(0,0,0,0.2);margin:10px 0 6px 0;}
.memo{font-size:13px;}
.error{color:red;font-weight:bold;font-size:12px;margin-top:4px;}
.change-info{font-size:12px;margin-top:8px;color:#444;display:flex;align-items:center;gap:6px;}
.change-info.orange{color:orange;font-weight:bold;}
.change-info.red{color:red;font-weight:bold;text-decoration:underline;}
.card-menu{position:absolute;top:8px;right:10px;cursor:pointer;}
.card-options{display:none;position:absolute;top:26px;right:8px;background:white;border:1px solid #ccc;border-radius:8px;padding:6px;font-size:12px;z-index:1000;}
.card-options div{padding:6px 8px;cursor:pointer;}
.card-options div:hover{background:#f0f0f0;}
.add-card-btn{margin-top:10px;padding:10px 0;border:none;border-radius:16px;background:#d0d8e8;font-size:22px;cursor:pointer;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;z-index:2000;}
.modal-content{background:white;padding:30px;border-radius:20px;width:600px;display:flex;flex-direction:column;gap:20px;}
.modal-fields{display:flex;gap:30px;justify-content:center;}
.modal-block{display:flex;flex-direction:column;gap:6px;align-items:center;}
.modal-block input{width:90px;padding:8px;border-radius:10px;border:1px solid #ccc;text-align:center;}
.modal-buttons{display:flex;justify-content:flex-end;gap:10px;}
.save-btn{background:#2d6cdf;color:white;padding:8px 16px;border:none;border-radius:10px;}
.cancel-btn{background:#ccc;padding:8px 16px;border:none;border-radius:10px;}
.mark-btn{background:#28a745;color:white;padding:4px 8px;border:none;border-radius:10px;font-size:11px;}
.task-card{
  background:white;
  padding:14px 20px;
  border-radius:18px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  display:flex;
  align-items:center;
  gap:20px;
  position:relative;
}

</style>
</head>

<body>

<h1 id="clock"></h1>

<div class="top-controls">
  <button onclick="addColumn()">열 추가</button>
  <button onclick="saveData()">저장</button>
  <button onclick="undoAction()">이전 행동 복구</button>
</div>
<hr style="margin:40px 0;border:1px dashed #bbb">

<h2 id="farmTitle"
    contenteditable="true"
    oninput="localStorage.setItem('farmBoardTitle', this.innerText)">
  재배기 현황
</h2>
<div class="board" id="board"></div>
<hr style="margin:40px 0;border:1px dashed #bbb">

<h2 id="taskTitle"
    contenteditable="true"
    oninput="localStorage.setItem('taskBoardTitle', this.innerText)">
  작업 배너
</h2>


<div id="taskBoard" style="display:flex;flex-direction:column;gap:12px;"></div>


<script>

// ===== 데이터 =====
let columns = JSON.parse(localStorage.getItem("farmData")) || [];
let tasks = JSON.parse(localStorage.getItem("taskData")) || [];
let historyStack = [];


// ===== 히스토리 =====
function saveHistory(){
  historyStack.push(JSON.stringify(columns));
  if(historyStack.length>50) historyStack.shift();
}

function undoAction(){
  if(historyStack.length===0){
    alert("되돌릴 작업이 없습니다.");
    return;
  }
  columns = JSON.parse(historyStack.pop());
  createUI();
}

// Ctrl+Z
document.addEventListener("keydown",(e)=>{
  if(e.ctrlKey && e.key==="z"){
    e.preventDefault();
    undoAction();
  }
});

// ===== 공용 =====
function saveData(){
  localStorage.setItem("farmData",JSON.stringify(columns));
localStorage.setItem("taskData",JSON.stringify(tasks));
  alert("저장 완료");
}


function formatDate(d){
  if(!d) return "-";
  return `${d.year}.${String(d.month).padStart(2,"0")}.${String(d.day).padStart(2,"0")}`;
}

function updateClock(){
  document.getElementById("clock").innerText=new Date().toLocaleString();
}

function validateDate(d){
  if(!d) return {valid:false,error:"값 없음"};
  const y=new Date().getFullYear();
  let err=[];
  if(d.year<y-1||d.year>y+1) err.push("yy 오류");
  if(d.month<1||d.month>12) err.push("mm 오류");
  if(d.day<1||d.day>31) err.push("dd 오류");
  return {valid:err.length===0,error:err.join(", ")};
}

function formatDays(date){
  if(!date) return "-";
  const diff=((new Date()-new Date(date.year,date.month-1,date.day,date.hour||0))/(1000*60*60*24)).toFixed(1);
  return diff+"일차";
}

// ===== 모달 =====
function createModal(html){
  const m=document.createElement("div");
  m.className="modal";
  m.innerHTML=html;

  m.onclick=(e)=>{ 
    if(e.target===m) m.remove(); 
  };

  // ✅ ESC로 닫기
  function escHandler(e){
    if(e.key==="Escape"){
      m.remove();
      document.removeEventListener("keydown",escHandler);
    }
  }
  document.addEventListener("keydown",escHandler);

  document.body.appendChild(m);
  return m;
}

function closeModal(btn){btn.closest(".modal").remove();}

// ===== 날짜 모달 =====
function dateInputs(p,d){
  return `
  <div class="modal-block">
    <label>년</label>
    <input type="number" id="${p}-year" value="${d.year}" min="2000" max="2100" step="1">
  </div>
  <div class="modal-block">
    <label>월</label>
    <input type="number" id="${p}-month" value="${d.month}" min="1" max="12" step="1">
  </div>
  <div class="modal-block">
    <label>일</label>
    <input type="number" id="${p}-day" value="${d.day}" min="1" max="31" step="1">
  </div>
  <div class="modal-block">
    <label>시간</label>
    <input type="number" id="${p}-hour" value="${d.hour||0}" min="0" max="23" step="1">
  </div>`;
}

function openDateEditor(c,r){
  const crop=columns[c].crops[r];
  if(crop.showSow===undefined) crop.showSow=true;
  if(crop.showTrans===undefined) crop.showTrans=true;

  createModal(`
    <div class="modal-content">
      <div>파종일</div>
      <div class="modal-fields">
        <div class="modal-block">
          <label>표시</label>
          <input type="checkbox" id="showSow" ${crop.showSow?"checked":""}>
        </div>
        ${dateInputs("sow",crop.sow)}
      </div>

      <div>정식일</div>
      <div class="modal-fields">
        <div class="modal-block">
          <label>표시</label>
          <input type="checkbox" id="showTrans" ${crop.showTrans?"checked":""}>
        </div>
        ${dateInputs("trans",crop.trans)}
      </div>

      <div class="modal-buttons">
        <button class="cancel-btn" onclick="closeModal(this)">취소</button>
        <button class="save-btn" onclick="saveDate(${c},${r},this)">저장</button>
      </div>
    </div>
  `);
}

function saveDate(c,r,btn){
  saveHistory();
  const m=btn.closest(".modal");

  columns[c].crops[r].sow={
    year:+m.querySelector("#sow-year").value,
    month:+m.querySelector("#sow-month").value,
    day:+m.querySelector("#sow-day").value,
    hour:+m.querySelector("#sow-hour").value
  };

  columns[c].crops[r].trans={
    year:+m.querySelector("#trans-year").value,
    month:+m.querySelector("#trans-month").value,
    day:+m.querySelector("#trans-day").value,
    hour:+m.querySelector("#trans-hour").value
  };

  columns[c].crops[r].showSow=m.querySelector("#showSow").checked;
  columns[c].crops[r].showTrans=m.querySelector("#showTrans").checked;

  m.remove();
  createUI();
}

// ===== 메모 =====
function openMemoEditor(c,r){
  const crop=columns[c].crops[r];
  createModal(`
  <div class="modal-content">
    <textarea id="memoText" style="height:100px">${crop.memo||""}</textarea>
    <div class="modal-buttons">
      <button class="cancel-btn" onclick="closeModal(this)">취소</button>
      <button class="save-btn" onclick="saveMemo(${c},${r},this)">저장</button>
    </div>
  </div>`);
}

function saveMemo(c,r,btn){
  saveHistory();
  columns[c].crops[r].memo=btn.closest(".modal").querySelector("#memoText").value;
  btn.closest(".modal").remove();
  createUI();
}

// ===== 양액 =====
function openChangeEditor(c,r){
  const crop=columns[c].crops[r];
  if(crop.showChange===undefined) crop.showChange=true;

  createModal(`
  <div class="modal-content">
    <div>양액 교체일</div>
    <div class="modal-fields">
      <div class="modal-block">
        <label>표시</label>
        <input type="checkbox" id="showChange" ${crop.showChange?"checked":""}>
      </div>
      ${dateInputs("change",crop.lastChange)}
    </div>
    <div class="modal-buttons">
      <button class="cancel-btn" onclick="closeModal(this)">취소</button>
      <button class="mark-btn" onclick="completeChangeNow(${c},${r},this)">교체 완료</button>
      <button class="save-btn" onclick="saveChange(${c},${r},this)">저장</button>
    </div>
  </div>`);
}

function completeChangeNow(c,r,btn){
  saveHistory();
  const now=new Date();

  columns[c].crops[r].lastChange={
    year:now.getFullYear(),
    month:now.getMonth()+1,
    day:now.getDate(),
    hour:now.getHours()
  };

  columns[c].crops[r].showChange=
    btn.closest(".modal").querySelector("#showChange").checked;

  btn.closest(".modal").remove();
  createUI();
}


function saveChange(c,r,btn){
  saveHistory();
  const m=btn.closest(".modal");

  columns[c].crops[r].lastChange={
    year:+m.querySelector("#change-year").value,
    month:+m.querySelector("#change-month").value,
    day:+m.querySelector("#change-day").value,
    hour:+m.querySelector("#change-hour").value
  };

  columns[c].crops[r].showChange=m.querySelector("#showChange").checked;

  m.remove();
  createUI();
}

// ===== UI 생성 =====
function createUI(){
  const board=document.getElementById("board");
  board.innerHTML="";

  columns.forEach((col,ci)=>{

const column=document.createElement("div");
column.className="column";
column.dataset.index=ci;


    column.innerHTML=`
      <div class="column-header">
        <div contenteditable oninput="columns[${ci}].header=this.innerText">${col.header}</div>
        <div onclick="deleteColumn(${ci})">✕</div>
      </div>
      <div class="card-container"></div>
    `;

    board.appendChild(column);
    const container=column.querySelector(".card-container");

    col.crops.forEach((crop,ri)=>{

      const sowVal=validateDate(crop.sow);
      const transVal=validateDate(crop.trans);

      let sowErr=sowVal.valid?"":sowVal.error;
      let transErr=transVal.valid?"":transVal.error;

let changeText="", changeClass="";


if(crop.lastChange){

  const now = new Date();
  const changeDate = new Date(
    crop.lastChange.year,
    crop.lastChange.month-1,
    crop.lastChange.day,
    crop.lastChange.hour||0
  );

  const diffDays = (now - changeDate) / (1000*60*60*24);

  if(changeDate > now){
    changeText = "양액 교체 : 날짜 오류";
    changeClass = "red";
  }else{

    const diff = diffDays.toFixed(1);
    changeText = `양액 교체 : D+${diff}`;

    if(diffDays >= 14){
      changeClass = "red";
    }else if(diffDays >= 7){
      changeClass = "orange";
    }
  }
}




      const card=document.createElement("div");
      card.className="card";

      card.innerHTML=`
        <div class="label" contenteditable
          oninput="columns[${ci}].crops[${ri}].name=this.innerText">${crop.name}</div>

        <div class="date-section">

          ${crop.showSow!==false ? `
          <div class="date-block">
            <div class="small">파종일</div>
            <div class="big ${sowErr?'error':''}">
              ${sowErr?sowErr:formatDays(crop.sow)}
            </div>
            <div class="date-text">${sowErr?"":formatDate(crop.sow)}</div>
          </div>`:""}

          ${(crop.showSow!==false && crop.showTrans!==false)?'<div class="divider-vertical"></div>':""}

          ${crop.showTrans!==false ? `
          <div class="date-block">
            <div class="small">정식일</div>
            <div class="big ${transErr?'error':''}">
              ${transErr?transErr:formatDays(crop.trans)}
            </div>
            <div class="date-text">${transErr?"":formatDate(crop.trans)}</div>
          </div>`:""}

        </div>

        ${crop.showChange!==false ? `
<div class="change-info ${changeClass}">

          ${changeText}
          <button class="mark-btn" style="margin-left:auto"
            onclick="markChangeNow(${ci},${ri})">↻</button>
        </div>`:""}

        ${crop.memo?`<div class="memo-divider"></div><div class="memo">${crop.memo}</div>`:""}

        <div class="card-menu">☰</div>
        <div class="card-options">
          <div onclick="openDateEditor(${ci},${ri})">날짜 수정</div>
          <div onclick="openMemoEditor(${ci},${ri})">메모</div>
          <div onclick="openChangeEditor(${ci},${ri})">양액 교체 주기</div>
          <div onclick="deleteCard(${ci},${ri})">삭제</div>
        </div>
      `;

      const menu=card.querySelector(".card-menu");
      const opt=card.querySelector(".card-options");

      menu.onclick=(e)=>{
        e.stopPropagation();
        document.querySelectorAll(".card-options").forEach(o=>o.style.display="none");
        opt.style.display="block";
      };

      container.appendChild(card);
    });

    new Sortable(container,{
      group:"shared",
      animation:150,
      onStart:()=>saveHistory(),
onEnd:(evt)=>{

  const fromColIndex = evt.from.closest(".column").dataset.index;
  const toColIndex   = evt.to.closest(".column").dataset.index;

  const movedItem = columns[fromColIndex].crops.splice(evt.oldIndex,1)[0];
  columns[toColIndex].crops.splice(evt.newIndex,0,movedItem);

  createUI();
}

    });

    const btn=document.createElement("button");
    btn.className="add-card-btn";
    btn.innerText="+";
    btn.onclick=()=>addCard(ci);
    column.appendChild(btn);
  });


}

// ===== CRUD =====
function addColumn(){
  saveHistory();
  columns.push({header:"새 열",crops:[]});
  createUI();
}

function deleteColumn(i){
  if(confirm("정말 삭제하시겠습니까?")){
    saveHistory();
    columns.splice(i,1);
    createUI();
  }
}

function addCard(i){
  saveHistory();
  const now=new Date();

  columns[i].crops.push({
    name:"새 카드",
    sow:{year:now.getFullYear(),month:now.getMonth()+1,day:now.getDate()},
    trans:{year:now.getFullYear(),month:now.getMonth()+1,day:now.getDate()},
    lastChange:{year:now.getFullYear(),month:now.getMonth()+1,day:now.getDate()},
    memo:""
  });

  createUI();
}

function deleteCard(c,r){
  saveHistory();
  columns[c].crops.splice(r,1);
  createUI();
}

function markChangeNow(c,r){
  saveHistory();
  const now=new Date();
  columns[c].crops[r].lastChange={
    year:now.getFullYear(),
    month:now.getMonth()+1,
    day:now.getDate(),
    hour:now.getHours()   // ✅ 시간 추가
  };
  createUI();
}

// =============================
// ===== 작업 배너 시스템 =====
// =============================

function createTaskUI(){

  const board=document.getElementById("taskBoard");
  board.innerHTML="";

  tasks.forEach((task,i)=>{
let diffDays=0;
let diffText="-";
let textStyle="";

if(task.start){
  const startDate=new Date(
    task.start.year,
    task.start.month-1,
    task.start.day,
    task.start.hour||0
  );

  const now=new Date();

  if(startDate>now){
    diffText="날짜 오류";
    textStyle="color:red;font-weight:bold;";
  }else{

    diffDays=(now-startDate)/(1000*60*60*24);
    diffText=`D+${diffDays.toFixed(1)}`;

    if(diffDays>=60){
      textStyle="color:red;font-weight:bold;text-decoration:underline;text-decoration-thickness:3px;";
    }else if(diffDays>=30){
      textStyle="color:orange;font-weight:bold;";
    }
  }
}

    const card=document.createElement("div");
    card.className="task-card";

    card.innerHTML=`
      <div contenteditable
        oninput="tasks[${i}].name=this.innerText"
        style="font-weight:bold;min-width:120px;">
        ${task.name}
      </div>

<div style="display:flex;align-items:center;gap:8px;">

<div style="font-size:18px;${textStyle}">
  ${diffText}
</div>


  <button class="mark-btn"
    onclick="markTaskNow(${i})">↻</button>

</div>

<div style="opacity:0.4;">|</div>

<div style="flex:1;font-size:14px;">
  ${task.memo||""}
</div>


      <div class="card-menu">☰</div>
      <div class="card-options">
        <div onclick="openTaskDateEditor(${i})">날짜 수정</div>
        <div onclick="openTaskMemoEditor(${i})">메모 수정</div>
        <div onclick="deleteTask(${i})">삭제</div>
      </div>
    `;

    const menu=card.querySelector(".card-menu");
    const opt=card.querySelector(".card-options");

    menu.onclick=(e)=>{
      e.stopPropagation();
      document.querySelectorAll(".card-options").forEach(o=>o.style.display="none");
      opt.style.display="block";
    };

    board.appendChild(card);
  });
// 재배기 현황과 동일한 스타일의 + 버튼
const btn=document.createElement("button");
btn.className="add-card-btn";
btn.innerText="+";
btn.onclick=addTask;

board.appendChild(btn);

new Sortable(board,{
  animation:150,
  onEnd:(evt)=>{
    const moved = tasks.splice(evt.oldIndex,1)[0];
    tasks.splice(evt.newIndex,0,moved);
    createTaskUI();
  }
});

}


function deleteTaskColumn(i){
  taskColumns.splice(i,1);
  createTaskUI();
}

function addTask(){
  const now=new Date();

  tasks.push({
    name:"새 작업",
    start:{
      year:now.getFullYear(),
      month:now.getMonth()+1,
      day:now.getDate(),
      hour:now.getHours()
    },
    memo:""
  });

  createTaskUI();
}


function deleteTask(i){
  tasks.splice(i,1);
  createTaskUI();
}


function markTaskNow(i){
  const now=new Date();
  tasks[i].start={
    year:now.getFullYear(),
    month:now.getMonth()+1,
    day:now.getDate(),
    hour:now.getHours()
  };
  createTaskUI();
}


function openTaskDateEditor(i){
  const task=tasks[i];

  createModal(`
    <div class="modal-content">
      <div>작업 시작일</div>
      <div class="modal-fields">
        ${dateInputs("task",task.start)}
      </div>
      <div class="modal-buttons">
        <button class="cancel-btn" onclick="closeModal(this)">취소</button>
        <button class="save-btn" onclick="saveTaskDate(${i},this)">저장</button>
      </div>
    </div>
  `);
}

function saveTaskDate(i,btn){
  const m=btn.closest(".modal");

  tasks[i].start={
    year:+m.querySelector("#task-year").value,
    month:+m.querySelector("#task-month").value,
    day:+m.querySelector("#task-day").value,
    hour:+m.querySelector("#task-hour").value
  };

  m.remove();
  createTaskUI();
}

function openTaskMemoEditor(i){
  const task=tasks[i];

  createModal(`
    <div class="modal-content">
      <textarea id="taskMemo" style="height:100px">${task.memo||""}</textarea>
      <div class="modal-buttons">
        <button class="cancel-btn" onclick="closeModal(this)">취소</button>
        <button class="save-btn" onclick="saveTaskMemo(${i},this)">저장</button>
      </div>
    </div>
  `);
}

function saveTaskMemo(i,btn){
  tasks[i].memo=
    btn.closest(".modal").querySelector("#taskMemo").value;

  btn.closest(".modal").remove();
  createTaskUI();
}

// ===== 기타 =====
document.addEventListener("click",(e)=>{
  if(!e.target.closest(".card"))
    document.querySelectorAll(".card-options").forEach(o=>o.style.display="none");
});

// 상단 제목 불러오기
const savedTitle = localStorage.getItem("farmBoardTitle");
if(savedTitle){
  document.getElementById("farmTitle").innerText = savedTitle;
}
// 작업 배너 제목 불러오기
const savedTaskTitle = localStorage.getItem("taskBoardTitle");
if(savedTaskTitle){
  document.getElementById("taskTitle").innerText = savedTaskTitle;
}
setInterval(updateClock,1000);
createUI();
createTaskUI();
updateClock();


</script>
</body>
</html>
