<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>재배 보드</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:20px;}
#clock{font-size:18px;margin:0;}
.top-controls{display:flex;gap:10px;}
.top-controls button{padding:8px 14px;border:none;border-radius:8px;background:#6c8fc7;color:white;cursor:pointer;}
.board{display:flex;gap:20px;align-items:flex-start;}
.column{background:#e9eef5;padding:12px;border-radius:20px;width:300px;display:flex;flex-direction:column;}
.column-header{background:#6c8fc7;color:white;padding:10px;border-radius:16px;font-weight:bold;display:flex;justify-content:space-between;}
.card-container{margin-top:10px;display:flex;flex-direction:column;gap:12px;}
.card{background:white;padding:16px;border-radius:18px;box-shadow:0 2px 6px rgba(0,0,0,0.1);position:relative;}
.label{font-weight:bold;margin-bottom:10px;outline:none;}
.date-section{display:flex;justify-content:space-between;margin-top:6px;}
.date-block{width:48%;display:flex;flex-direction:column;}
.small{font-size:11px;color:#666;}
.big{font-size:18px;font-weight:bold;margin:2px 0;}
.date-text{font-size:13px;}
.divider-vertical{width:1px;background:rgba(0,0,0,0.15);}
.memo-divider{height:1px;background:rgba(0,0,0,0.2);margin:10px 0 6px 0;}
.memo{font-size:13px;}
.error{color:red;font-weight:bold;font-size:12px;margin-top:4px;}
.change-info{font-size:12px;margin-top:8px;color:#444;display:flex;align-items:center;gap:6px;}
.change-info.orange{color:orange;font-weight:bold;}
.change-info.red{color:red;font-weight:bold;text-decoration:underline;}
.card-menu{position:absolute;top:8px;right:10px;cursor:pointer;}
.card-options{display:none;position:absolute;top:26px;right:8px;background:white;border:1px solid #ccc;border-radius:8px;padding:6px;font-size:12px;z-index:1000;}
.card-options div{padding:6px 8px;cursor:pointer;}
.card-options div:hover{background:#f0f0f0;}
.add-card-btn{margin-top:10px;padding:10px 0;border:none;border-radius:16px;background:#d0d8e8;font-size:22px;cursor:pointer;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;z-index:2000;}
.modal-content{background:white;padding:30px;border-radius:20px;width:600px;display:flex;flex-direction:column;gap:20px;}
.modal-fields{display:flex;gap:30px;justify-content:center;}
.modal-block{display:flex;flex-direction:column;gap:6px;align-items:center;}
.modal-block input{width:90px;padding:8px;border-radius:10px;border:1px solid #ccc;text-align:center;}
.modal-buttons{display:flex;justify-content:flex-end;gap:10px;}
.save-btn{background:#6c8fc7;color:white;padding:8px 16px;border:none;border-radius:10px;}
.cancel-btn{background:#ccc;padding:8px 16px;border:none;border-radius:10px;}
.mark-btn{background:#28a745;color:white;padding:4px 8px;border:none;border-radius:10px;font-size:11px;}
.task-card{
  background:white;
  padding:14px 20px;
  border-radius:18px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  display:flex;
  align-items:center;
  gap:20px;
  position:relative;
}

.top-bar{
  display:flex;
  align-items:center;
  margin-bottom:20px;
}

.top-controls{
  margin-left:auto;
  display:flex;
  gap:10px;
}
</style>
</head>

<body>

<div class="top-bar">
  <h1 id="clock"></h1>
  <div class="top-controls">
    <button onclick="addColumn()">열 추가</button>
    <button onclick="saveData()">저장</button>
    <button onclick="undoAction()">이전 행동 복구</button>
  </div>
</div>
<hr style="margin:-5px 0;border:1px dashed #bbb">

<h2 id="farmTitle"
    contenteditable="true"
    oninput="updateTitle()">
  재배기 현황
</h2>
<div class="board" id="board"></div>
<hr style="margin:0px 0;border:1px dashed #bbb">

<h2 id="taskTitle"
    contenteditable="true"
    oninput="updateTitle()">
  작업 배너
</h2>
<div id="taskBoard" style="display:flex;flex-direction:column;gap:12px;"></div>

<script type="module">

// ===== Firebase 초기화 =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

const firebaseConfig = {
  apiKey: "AIzaSyAnfstiWWezjQY4YJ3YJae8tsTGb3s9F-k",
  authDomain: "spinachslave.firebaseapp.com",
  projectId: "spinachslave",
  storageBucket: "spinachslave.firebasestorage.app",
  messagingSenderId: "974550491647",
  appId: "1:974550491647:web:f6359153646a7ffc9307ca",
  measurementId: "G-5VNY8MXJ4S"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);

// ===== 데이터 =====
let columns = [];
let tasks = [];
let historyStack = [];

// ===== Firestore 불러오기 =====
async function loadData() {
  const docRef = doc(db, "farmData", "board");
  const docSnap = await getDoc(docRef);
  if(docSnap.exists()){
    const data = docSnap.data();
    columns = data.columns || [];
    tasks = data.tasks || [];
  } else {
    columns = [];
    tasks = [];
  }
  createUI();
  createTaskUI();
}

loadData();

// ===== 히스토리 =====
function saveHistory(){
  historyStack.push(JSON.stringify(columns));
  if(historyStack.length>50) historyStack.shift();
}

function undoAction(){
  if(historyStack.length===0){
    alert("되돌릴 작업이 없습니다.");
    return;
  }
  columns = JSON.parse(historyStack.pop());
  createUI();
}

// ===== 공용 저장 =====
async function saveData(){
  try{
    await setDoc(doc(db,"farmData","board"), {columns,tasks});
    alert("Firestore에 저장 완료 ✅");
  }catch(e){
    console.error("Firestore 저장 오류:", e);
    alert("저장 실패 ❌");
  }
}

// ===== 제목 저장 =====
function updateTitle(){
  const farmTitle=document.getElementById("farmTitle").innerText;
  const taskTitle=document.getElementById("taskTitle").innerText;
  // 선택적으로 Firestore에 저장
}

// ===== 기존 코드 계속 =====
function formatDate(d){ if(!d) return "-"; return `${d.year}.${String(d.month).padStart(2,"0")}.${String(d.day).padStart(2,"0")}`; }
function updateClock(){ document.getElementById("clock").innerText=new Date().toLocaleString(); }
function validateDate(d){ if(!d) return {valid:false,error:"값 없음"}; const y=new Date().getFullYear(); let err=[]; if(d.year<y-1||d.year>y+1) err.push("yy 오류"); if(d.month<1||d.month>12) err.push("mm 오류"); if(d.day<1||d.day>31) err.push("dd 오류"); return {valid:err.length===0,error:err.join(", ")}; }
function formatDays(date){ if(!date) return "-"; const diff=((new Date()-new Date(date.year,date.month-1,date.day,date.hour||0))/(1000*60*60*24)).toFixed(1); return diff+"일차"; }

// ===== 이하 모든 UI 생성, 모달, CRUD, 작업 배너 함수 등 기존 코드 그대로 =====
// (여기서는 길이 때문에 생략했지만, 기존 스크립트 블록을 그대로 넣으면 됨)

setInterval(updateClock,1000);
</script>
</body>
</html>
